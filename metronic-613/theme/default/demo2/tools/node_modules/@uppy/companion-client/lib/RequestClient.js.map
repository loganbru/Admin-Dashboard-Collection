{"version":3,"sources":["RequestClient.js"],"names":["AuthError","require","fetchWithNetworkError","stripSlash","url","replace","module","exports","uppy","opts","onReceiveResponse","bind","allowedHeaders","preflightDone","headers","userHeaders","companionHeaders","serverHeaders","Promise","resolve","defaultHeaders","_getPostResponseFunc","skip","response","state","getState","companion","host","companionUrl","has","get","setState","_getUrl","test","hostname","_json","res","status","errMsg","statusText","json","then","errData","message","requestId","Error","catch","preflight","path","slice","fetch","method","split","map","headerName","trim","toLowerCase","err","log","preflightAndHeaders","all","Object","keys","forEach","header","indexOf","skipPostResponse","credentials","isAuthError","reject","post","data","body","JSON","stringify","delete","Accept","RequestClient","VERSION"],"mappings":"AAAA;;;;;;;;;;AAEA,IAAMA,SAAS,GAAGC,OAAO,CAAC,aAAD,CAAzB;;AACA,IAAMC,qBAAqB,GAAGD,OAAO,CAAC,uCAAD,CAArC,C,CAEA;;;AACA,SAASE,UAAT,CAAqBC,GAArB,EAA0B;AACxB,SAAOA,GAAG,CAACC,OAAJ,CAAY,KAAZ,EAAmB,EAAnB,CAAP;AACD;;AAEDC,MAAM,CAACC,OAAP;AAGE,yBAAaC,IAAb,EAAmBC,IAAnB,EAAyB;AACvB,SAAKD,IAAL,GAAYA,IAAZ;AACA,SAAKC,IAAL,GAAYA,IAAZ;AACA,SAAKC,iBAAL,GAAyB,KAAKA,iBAAL,CAAuBC,IAAvB,CAA4B,IAA5B,CAAzB;AACA,SAAKC,cAAL,GAAsB,CAAC,QAAD,EAAW,cAAX,EAA2B,iBAA3B,CAAtB;AACA,SAAKC,aAAL,GAAqB,KAArB;AACD;;AATH;;AAAA,SAyBEC,OAzBF,GAyBE,mBAAW;AACT,QAAMC,WAAW,GAAG,KAAKN,IAAL,CAAUO,gBAAV,IAA8B,KAAKP,IAAL,CAAUQ,aAAxC,IAAyD,EAA7E;AACA,WAAOC,OAAO,CAACC,OAAR,cACF,KAAKC,cADH,EAEFL,WAFE,EAAP;AAID,GA/BH;;AAAA,SAiCEM,oBAjCF,GAiCE,8BAAsBC,IAAtB,EAA4B;AAAA;;AAC1B,WAAO,UAACC,QAAD,EAAc;AACnB,UAAI,CAACD,IAAL,EAAW;AACT,eAAO,KAAI,CAACZ,iBAAL,CAAuBa,QAAvB,CAAP;AACD;;AAED,aAAOA,QAAP;AACD,KAND;AAOD,GAzCH;;AAAA,SA2CEb,iBA3CF,GA2CE,2BAAmBa,QAAnB,EAA6B;AAC3B,QAAMC,KAAK,GAAG,KAAKhB,IAAL,CAAUiB,QAAV,EAAd;AACA,QAAMC,SAAS,GAAGF,KAAK,CAACE,SAAN,IAAmB,EAArC;AACA,QAAMC,IAAI,GAAG,KAAKlB,IAAL,CAAUmB,YAAvB;AACA,QAAMd,OAAO,GAAGS,QAAQ,CAACT,OAAzB,CAJ2B,CAK3B;;AACA,QAAIA,OAAO,CAACe,GAAR,CAAY,MAAZ,KAAuBf,OAAO,CAACgB,GAAR,CAAY,MAAZ,MAAwBJ,SAAS,CAACC,IAAD,CAA5D,EAAoE;AAAA;;AAClE,WAAKnB,IAAL,CAAUuB,QAAV,CAAmB;AACjBL,QAAAA,SAAS,EAAE,SAAc,EAAd,EAAkBA,SAAlB,6BACRC,IADQ,IACDb,OAAO,CAACgB,GAAR,CAAY,MAAZ,CADC;AADM,OAAnB;AAKD;;AACD,WAAOP,QAAP;AACD,GAzDH;;AAAA,SA2DES,OA3DF,GA2DE,iBAAS5B,GAAT,EAAc;AACZ,QAAI,kBAAkB6B,IAAlB,CAAuB7B,GAAvB,CAAJ,EAAiC;AAC/B,aAAOA,GAAP;AACD;;AACD,WAAU,KAAK8B,QAAf,SAA2B9B,GAA3B;AACD,GAhEH;;AAAA,SAkEE+B,KAlEF,GAkEE,eAAOC,GAAP,EAAY;AACV,QAAIA,GAAG,CAACC,MAAJ,KAAe,GAAnB,EAAwB;AACtB,YAAM,IAAIrC,SAAJ,EAAN;AACD;;AAED,QAAIoC,GAAG,CAACC,MAAJ,GAAa,GAAb,IAAoBD,GAAG,CAACC,MAAJ,GAAa,GAArC,EAA0C;AACxC,UAAIC,MAAM,oCAAkCF,GAAG,CAACC,MAAtC,UAAiDD,GAAG,CAACG,UAA/D;AACA,aAAOH,GAAG,CAACI,IAAJ,GACJC,IADI,CACC,UAACC,OAAD,EAAa;AACjBJ,QAAAA,MAAM,GAAGI,OAAO,CAACC,OAAR,GAAqBL,MAArB,kBAAwCI,OAAO,CAACC,OAAhD,GAA4DL,MAArE;AACAA,QAAAA,MAAM,GAAGI,OAAO,CAACE,SAAR,GAAuBN,MAAvB,qBAA6CI,OAAO,CAACE,SAArD,GAAmEN,MAA5E;AACA,cAAM,IAAIO,KAAJ,CAAUP,MAAV,CAAN;AACD,OALI,EAKFQ,KALE,CAKI,YAAM;AAAE,cAAM,IAAID,KAAJ,CAAUP,MAAV,CAAN;AAAyB,OALrC,CAAP;AAMD;;AACD,WAAOF,GAAG,CAACI,IAAJ,EAAP;AACD,GAjFH;;AAAA,SAmFEO,SAnFF,GAmFE,mBAAWC,IAAX,EAAiB;AAAA;;AACf,QAAI,KAAKnC,aAAT,EAAwB;AACtB,aAAOK,OAAO,CAACC,OAAR,CAAgB,KAAKP,cAAL,CAAoBqC,KAApB,EAAhB,CAAP;AACD;;AAED,WAAOC,KAAK,CAAC,KAAKlB,OAAL,CAAagB,IAAb,CAAD,EAAqB;AAC/BG,MAAAA,MAAM,EAAE;AADuB,KAArB,CAAL,CAGJV,IAHI,CAGC,UAAClB,QAAD,EAAc;AAClB,UAAIA,QAAQ,CAACT,OAAT,CAAiBe,GAAjB,CAAqB,8BAArB,CAAJ,EAA0D;AACxD,QAAA,MAAI,CAACjB,cAAL,GAAsBW,QAAQ,CAACT,OAAT,CAAiBgB,GAAjB,CAAqB,8BAArB,EACnBsB,KADmB,CACb,GADa,EACRC,GADQ,CACJ,UAACC,UAAD;AAAA,iBAAgBA,UAAU,CAACC,IAAX,GAAkBC,WAAlB,EAAhB;AAAA,SADI,CAAtB;AAED;;AACD,MAAA,MAAI,CAAC3C,aAAL,GAAqB,IAArB;AACA,aAAO,MAAI,CAACD,cAAL,CAAoBqC,KAApB,EAAP;AACD,KAVI,EAWJH,KAXI,CAWE,UAACW,GAAD,EAAS;AACd,MAAA,MAAI,CAACjD,IAAL,CAAUkD,GAAV,yDAAoED,GAApE,EAA2E,SAA3E;;AACA,MAAA,MAAI,CAAC5C,aAAL,GAAqB,IAArB;AACA,aAAO,MAAI,CAACD,cAAL,CAAoBqC,KAApB,EAAP;AACD,KAfI,CAAP;AAgBD,GAxGH;;AAAA,SA0GEU,mBA1GF,GA0GE,6BAAqBX,IAArB,EAA2B;AAAA;;AACzB,WAAO9B,OAAO,CAAC0C,GAAR,CAAY,CAAC,KAAKb,SAAL,CAAeC,IAAf,CAAD,EAAuB,KAAKlC,OAAL,EAAvB,CAAZ,EACJ2B,IADI,CACC,gBAA+B;AAAA,UAA7B7B,cAA6B;AAAA,UAAbE,OAAa;AACnC;AACA+C,MAAAA,MAAM,CAACC,IAAP,CAAYhD,OAAZ,EAAqBiD,OAArB,CAA6B,UAACC,MAAD,EAAY;AACvC,YAAIpD,cAAc,CAACqD,OAAf,CAAuBD,MAAM,CAACR,WAAP,EAAvB,MAAiD,CAAC,CAAtD,EAAyD;AACvD,UAAA,MAAI,CAAChD,IAAL,CAAUkD,GAAV,mDAA8DM,MAA9D;;AACA,iBAAOlD,OAAO,CAACkD,MAAD,CAAd;AACD;AACF,OALD;AAOA,aAAOlD,OAAP;AACD,KAXI,CAAP;AAYD,GAvHH;;AAAA,SAyHEgB,GAzHF,GAyHE,aAAKkB,IAAL,EAAWkB,gBAAX,EAA6B;AAAA;;AAC3B,WAAO,KAAKP,mBAAL,CAAyBX,IAAzB,EACJP,IADI,CACC,UAAC3B,OAAD;AAAA,aACJZ,qBAAqB,CAAC,MAAI,CAAC8B,OAAL,CAAagB,IAAb,CAAD,EAAqB;AACxCG,QAAAA,MAAM,EAAE,KADgC;AAExCrC,QAAAA,OAAO,EAAEA,OAF+B;AAGxCqD,QAAAA,WAAW,EAAE;AAH2B,OAArB,CADjB;AAAA,KADD,EAOJ1B,IAPI,CAOC,KAAKpB,oBAAL,CAA0B6C,gBAA1B,CAPD,EAQJzB,IARI,CAQC,UAACL,GAAD;AAAA,aAAS,MAAI,CAACD,KAAL,CAAWC,GAAX,CAAT;AAAA,KARD,EASJU,KATI,CASE,UAACW,GAAD,EAAS;AACdA,MAAAA,GAAG,GAAGA,GAAG,CAACW,WAAJ,GAAkBX,GAAlB,GAAwB,IAAIZ,KAAJ,oBAA2B,MAAI,CAACb,OAAL,CAAagB,IAAb,CAA3B,UAAkDS,GAAlD,CAA9B;AACA,aAAOvC,OAAO,CAACmD,MAAR,CAAeZ,GAAf,CAAP;AACD,KAZI,CAAP;AAaD,GAvIH;;AAAA,SAyIEa,IAzIF,GAyIE,cAAMtB,IAAN,EAAYuB,IAAZ,EAAkBL,gBAAlB,EAAoC;AAAA;;AAClC,WAAO,KAAKP,mBAAL,CAAyBX,IAAzB,EACJP,IADI,CACC,UAAC3B,OAAD;AAAA,aACJZ,qBAAqB,CAAC,MAAI,CAAC8B,OAAL,CAAagB,IAAb,CAAD,EAAqB;AACxCG,QAAAA,MAAM,EAAE,MADgC;AAExCrC,QAAAA,OAAO,EAAEA,OAF+B;AAGxCqD,QAAAA,WAAW,EAAE,aAH2B;AAIxCK,QAAAA,IAAI,EAAEC,IAAI,CAACC,SAAL,CAAeH,IAAf;AAJkC,OAArB,CADjB;AAAA,KADD,EAQJ9B,IARI,CAQC,KAAKpB,oBAAL,CAA0B6C,gBAA1B,CARD,EASJzB,IATI,CASC,UAACL,GAAD;AAAA,aAAS,MAAI,CAACD,KAAL,CAAWC,GAAX,CAAT;AAAA,KATD,EAUJU,KAVI,CAUE,UAACW,GAAD,EAAS;AACdA,MAAAA,GAAG,GAAGA,GAAG,CAACW,WAAJ,GAAkBX,GAAlB,GAAwB,IAAIZ,KAAJ,qBAA4B,MAAI,CAACb,OAAL,CAAagB,IAAb,CAA5B,UAAmDS,GAAnD,CAA9B;AACA,aAAOvC,OAAO,CAACmD,MAAR,CAAeZ,GAAf,CAAP;AACD,KAbI,CAAP;AAcD,GAxJH;;AAAA,SA0JEkB,MA1JF,GA0JE,iBAAQ3B,IAAR,EAAcuB,IAAd,EAAoBL,gBAApB,EAAsC;AAAA;;AACpC,WAAO,KAAKP,mBAAL,CAAyBX,IAAzB,EACJP,IADI,CACC,UAAC3B,OAAD;AAAA,aACJZ,qBAAqB,CAAI,MAAI,CAACgC,QAAT,SAAqBc,IAArB,EAA6B;AAChDG,QAAAA,MAAM,EAAE,QADwC;AAEhDrC,QAAAA,OAAO,EAAEA,OAFuC;AAGhDqD,QAAAA,WAAW,EAAE,aAHmC;AAIhDK,QAAAA,IAAI,EAAED,IAAI,GAAGE,IAAI,CAACC,SAAL,CAAeH,IAAf,CAAH,GAA0B;AAJY,OAA7B,CADjB;AAAA,KADD,EAQJ9B,IARI,CAQC,KAAKpB,oBAAL,CAA0B6C,gBAA1B,CARD,EASJzB,IATI,CASC,UAACL,GAAD;AAAA,aAAS,MAAI,CAACD,KAAL,CAAWC,GAAX,CAAT;AAAA,KATD,EAUJU,KAVI,CAUE,UAACW,GAAD,EAAS;AACdA,MAAAA,GAAG,GAAGA,GAAG,CAACW,WAAJ,GAAkBX,GAAlB,GAAwB,IAAIZ,KAAJ,uBAA8B,MAAI,CAACb,OAAL,CAAagB,IAAb,CAA9B,UAAqDS,GAArD,CAA9B;AACA,aAAOvC,OAAO,CAACmD,MAAR,CAAeZ,GAAf,CAAP;AACD,KAbI,CAAP;AAcD,GAzKH;;AAAA;AAAA;AAAA,wBAWkB;AAAA,gCACQ,KAAKjD,IAAL,CAAUiB,QAAV,EADR;AAAA,UACNC,SADM,uBACNA,SADM;;AAEd,UAAMC,IAAI,GAAG,KAAKlB,IAAL,CAAUmB,YAAvB;AACA,aAAOzB,UAAU,CAACuB,SAAS,IAAIA,SAAS,CAACC,IAAD,CAAtB,GAA+BD,SAAS,CAACC,IAAD,CAAxC,GAAiDA,IAAlD,CAAjB;AACD;AAfH;AAAA;AAAA,wBAiBwB;AACpB,aAAO;AACLiD,QAAAA,MAAM,EAAE,kBADH;AAEL,wBAAgB,kBAFX;AAGL,qDAA2CC,aAAa,CAACC;AAHpD,OAAP;AAKD;AAvBH;;AAAA;AAAA,YACSA,OADT","sourcesContent":["'use strict'\n\nconst AuthError = require('./AuthError')\nconst fetchWithNetworkError = require('@uppy/utils/lib/fetchWithNetworkError')\n\n// Remove the trailing slash so we can always safely append /xyz.\nfunction stripSlash (url) {\n  return url.replace(/\\/$/, '')\n}\n\nmodule.exports = class RequestClient {\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    this.uppy = uppy\n    this.opts = opts\n    this.onReceiveResponse = this.onReceiveResponse.bind(this)\n    this.allowedHeaders = ['accept', 'content-type', 'uppy-auth-token']\n    this.preflightDone = false\n  }\n\n  get hostname () {\n    const { companion } = this.uppy.getState()\n    const host = this.opts.companionUrl\n    return stripSlash(companion && companion[host] ? companion[host] : host)\n  }\n\n  get defaultHeaders () {\n    return {\n      Accept: 'application/json',\n      'Content-Type': 'application/json',\n      'Uppy-Versions': `@uppy/companion-client=${RequestClient.VERSION}`\n    }\n  }\n\n  headers () {\n    const userHeaders = this.opts.companionHeaders || this.opts.serverHeaders || {}\n    return Promise.resolve({\n      ...this.defaultHeaders,\n      ...userHeaders\n    })\n  }\n\n  _getPostResponseFunc (skip) {\n    return (response) => {\n      if (!skip) {\n        return this.onReceiveResponse(response)\n      }\n\n      return response\n    }\n  }\n\n  onReceiveResponse (response) {\n    const state = this.uppy.getState()\n    const companion = state.companion || {}\n    const host = this.opts.companionUrl\n    const headers = response.headers\n    // Store the self-identified domain name for the Companion instance we just hit.\n    if (headers.has('i-am') && headers.get('i-am') !== companion[host]) {\n      this.uppy.setState({\n        companion: Object.assign({}, companion, {\n          [host]: headers.get('i-am')\n        })\n      })\n    }\n    return response\n  }\n\n  _getUrl (url) {\n    if (/^(https?:|)\\/\\//.test(url)) {\n      return url\n    }\n    return `${this.hostname}/${url}`\n  }\n\n  _json (res) {\n    if (res.status === 401) {\n      throw new AuthError()\n    }\n\n    if (res.status < 200 || res.status > 300) {\n      let errMsg = `Failed request with status: ${res.status}. ${res.statusText}`\n      return res.json()\n        .then((errData) => {\n          errMsg = errData.message ? `${errMsg} message: ${errData.message}` : errMsg\n          errMsg = errData.requestId ? `${errMsg} request-Id: ${errData.requestId}` : errMsg\n          throw new Error(errMsg)\n        }).catch(() => { throw new Error(errMsg) })\n    }\n    return res.json()\n  }\n\n  preflight (path) {\n    if (this.preflightDone) {\n      return Promise.resolve(this.allowedHeaders.slice())\n    }\n\n    return fetch(this._getUrl(path), {\n      method: 'OPTIONS'\n    })\n      .then((response) => {\n        if (response.headers.has('access-control-allow-headers')) {\n          this.allowedHeaders = response.headers.get('access-control-allow-headers')\n            .split(',').map((headerName) => headerName.trim().toLowerCase())\n        }\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n      .catch((err) => {\n        this.uppy.log(`[CompanionClient] unable to make preflight request ${err}`, 'warning')\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n  }\n\n  preflightAndHeaders (path) {\n    return Promise.all([this.preflight(path), this.headers()])\n      .then(([allowedHeaders, headers]) => {\n        // filter to keep only allowed Headers\n        Object.keys(headers).forEach((header) => {\n          if (allowedHeaders.indexOf(header.toLowerCase()) === -1) {\n            this.uppy.log(`[CompanionClient] excluding unallowed header ${header}`)\n            delete headers[header]\n          }\n        })\n\n        return headers\n      })\n  }\n\n  get (path, skipPostResponse) {\n    return this.preflightAndHeaders(path)\n      .then((headers) =>\n        fetchWithNetworkError(this._getUrl(path), {\n          method: 'get',\n          headers: headers,\n          credentials: 'same-origin'\n        }))\n      .then(this._getPostResponseFunc(skipPostResponse))\n      .then((res) => this._json(res))\n      .catch((err) => {\n        err = err.isAuthError ? err : new Error(`Could not get ${this._getUrl(path)}. ${err}`)\n        return Promise.reject(err)\n      })\n  }\n\n  post (path, data, skipPostResponse) {\n    return this.preflightAndHeaders(path)\n      .then((headers) =>\n        fetchWithNetworkError(this._getUrl(path), {\n          method: 'post',\n          headers: headers,\n          credentials: 'same-origin',\n          body: JSON.stringify(data)\n        }))\n      .then(this._getPostResponseFunc(skipPostResponse))\n      .then((res) => this._json(res))\n      .catch((err) => {\n        err = err.isAuthError ? err : new Error(`Could not post ${this._getUrl(path)}. ${err}`)\n        return Promise.reject(err)\n      })\n  }\n\n  delete (path, data, skipPostResponse) {\n    return this.preflightAndHeaders(path)\n      .then((headers) =>\n        fetchWithNetworkError(`${this.hostname}/${path}`, {\n          method: 'delete',\n          headers: headers,\n          credentials: 'same-origin',\n          body: data ? JSON.stringify(data) : null\n        }))\n      .then(this._getPostResponseFunc(skipPostResponse))\n      .then((res) => this._json(res))\n      .catch((err) => {\n        err = err.isAuthError ? err : new Error(`Could not delete ${this._getUrl(path)}. ${err}`)\n        return Promise.reject(err)\n      })\n  }\n}\n"]}