{"version":3,"sources":["index.js"],"names":["require","Plugin","Socket","Provider","RequestClient","EventTracker","emitSocketProgress","getSocketHost","RateLimitedQueue","Uploader","assertServerError","res","error","Error","message","module","exports","uppy","opts","type","id","title","client","defaultOptions","timeout","limit","retryDelays","createMultipartUpload","bind","listParts","prepareUploadPart","abortMultipartUpload","completeMultipartUpload","upload","requests","uploaders","Object","create","uploaderEvents","uploaderSockets","resetUploaderReferences","fileID","abort","really","remove","close","assertHost","method","companionUrl","file","metadata","keys","meta","map","key","toString","post","filename","name","then","uploadId","encodeURIComponent","get","number","parts","uploadIdEnc","delete","uploadFile","Promise","resolve","reject","onStart","data","cFile","getFile","setFileState","s3Multipart","onProgress","bytesUploaded","bytesTotal","emit","uploader","onError","err","log","queuedRequest","done","onSuccess","result","uploadResp","body","uploadURL","location","onPartComplete","part","getChunkSize","run","isPaused","start","onFileRemove","removed","onCancelAll","onFilePause","pause","onPauseAll","onResumeAll","isRestored","uploadRemote","serverToken","connectToServerSocket","Client","remote","providerOptions","provider","url","protocol","size","token","catch","host","socket","target","autoOpen","send","onRetry","isOpen","onRetryAll","on","progressData","errData","open","fileIDs","length","promises","isRemote","all","cb","targetFileID","filesToRetry","install","getState","capabilities","setState","resumableUploads","addUploader","uninstall","removeUploader","VERSION"],"mappings":"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","sourcesContent":["const { Plugin } = require('@uppy/core')\nconst { Socket, Provider, RequestClient } = require('@uppy/companion-client')\nconst EventTracker = require('@uppy/utils/lib/EventTracker')\nconst emitSocketProgress = require('@uppy/utils/lib/emitSocketProgress')\nconst getSocketHost = require('@uppy/utils/lib/getSocketHost')\nconst RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue')\nconst Uploader = require('./MultipartUploader')\n\nfunction assertServerError (res) {\n  if (res && res.error) {\n    const error = new Error(res.message)\n    Object.assign(error, res.error)\n    throw error\n  }\n  return res\n}\n\nmodule.exports = class AwsS3Multipart extends Plugin {\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'AwsS3Multipart'\n    this.title = 'AWS S3 Multipart'\n    this.client = new RequestClient(uppy, opts)\n\n    const defaultOptions = {\n      timeout: 30 * 1000,\n      limit: 0,\n      retryDelays: [0, 1000, 3000, 5000],\n      createMultipartUpload: this.createMultipartUpload.bind(this),\n      listParts: this.listParts.bind(this),\n      prepareUploadPart: this.prepareUploadPart.bind(this),\n      abortMultipartUpload: this.abortMultipartUpload.bind(this),\n      completeMultipartUpload: this.completeMultipartUpload.bind(this)\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.upload = this.upload.bind(this)\n\n    this.requests = new RateLimitedQueue(this.opts.limit)\n\n    this.uploaders = Object.create(null)\n    this.uploaderEvents = Object.create(null)\n    this.uploaderSockets = Object.create(null)\n  }\n\n  /**\n   * Clean up all references for a file's upload: the MultipartUploader instance,\n   * any events related to the file, and the Companion WebSocket connection.\n   *\n   * Set `opts.abort` to tell S3 that the multipart upload is cancelled and must be removed.\n   * This should be done when the user cancels the upload, not when the upload is completed or errored.\n   */\n  resetUploaderReferences (fileID, opts = {}) {\n    if (this.uploaders[fileID]) {\n      this.uploaders[fileID].abort({ really: opts.abort || false })\n      this.uploaders[fileID] = null\n    }\n    if (this.uploaderEvents[fileID]) {\n      this.uploaderEvents[fileID].remove()\n      this.uploaderEvents[fileID] = null\n    }\n    if (this.uploaderSockets[fileID]) {\n      this.uploaderSockets[fileID].close()\n      this.uploaderSockets[fileID] = null\n    }\n  }\n\n  assertHost (method) {\n    if (!this.opts.companionUrl) {\n      throw new Error(`Expected a \\`companionUrl\\` option containing a Companion address, or if you are not using Companion, a custom \\`${method}\\` implementation.`)\n    }\n  }\n\n  createMultipartUpload (file) {\n    this.assertHost('createMultipartUpload')\n\n    const metadata = {}\n\n    Object.keys(file.meta).map(key => {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString()\n      }\n    })\n\n    return this.client.post('s3/multipart', {\n      filename: file.name,\n      type: file.type,\n      metadata\n    }).then(assertServerError)\n  }\n\n  listParts (file, { key, uploadId }) {\n    this.assertHost('listParts')\n\n    const filename = encodeURIComponent(key)\n    return this.client.get(`s3/multipart/${uploadId}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  prepareUploadPart (file, { key, uploadId, number }) {\n    this.assertHost('prepareUploadPart')\n\n    const filename = encodeURIComponent(key)\n    return this.client.get(`s3/multipart/${uploadId}/${number}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  completeMultipartUpload (file, { key, uploadId, parts }) {\n    this.assertHost('completeMultipartUpload')\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.client.post(`s3/multipart/${uploadIdEnc}/complete?key=${filename}`, { parts })\n      .then(assertServerError)\n  }\n\n  abortMultipartUpload (file, { key, uploadId }) {\n    this.assertHost('abortMultipartUpload')\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.client.delete(`s3/multipart/${uploadIdEnc}?key=${filename}`)\n      .then(assertServerError)\n  }\n\n  uploadFile (file) {\n    return new Promise((resolve, reject) => {\n      const onStart = (data) => {\n        const cFile = this.uppy.getFile(file.id)\n        this.uppy.setFileState(file.id, {\n          s3Multipart: {\n            ...cFile.s3Multipart,\n            key: data.key,\n            uploadId: data.uploadId\n          }\n        })\n      }\n\n      const onProgress = (bytesUploaded, bytesTotal) => {\n        this.uppy.emit('upload-progress', file, {\n          uploader: this,\n          bytesUploaded: bytesUploaded,\n          bytesTotal: bytesTotal\n        })\n      }\n\n      const onError = (err) => {\n        this.uppy.log(err)\n        this.uppy.emit('upload-error', file, err)\n\n        queuedRequest.done()\n        this.resetUploaderReferences(file.id)\n        reject(err)\n      }\n\n      const onSuccess = (result) => {\n        const uploadResp = {\n          body: {\n            ...result\n          },\n          uploadURL: result.location\n        }\n\n        queuedRequest.done()\n        this.resetUploaderReferences(file.id)\n\n        this.uppy.emit('upload-success', file, uploadResp)\n\n        if (result.location) {\n          this.uppy.log('Download ' + upload.file.name + ' from ' + result.location)\n        }\n\n        resolve(upload)\n      }\n\n      const onPartComplete = (part) => {\n        const cFile = this.uppy.getFile(file.id)\n        if (!cFile) {\n          return\n        }\n\n        this.uppy.emit('s3-multipart:part-uploaded', cFile, part)\n      }\n\n      const upload = new Uploader(file.data, {\n        // .bind to pass the file object to each handler.\n        createMultipartUpload: this.opts.createMultipartUpload.bind(this, file),\n        listParts: this.opts.listParts.bind(this, file),\n        prepareUploadPart: this.opts.prepareUploadPart.bind(this, file),\n        completeMultipartUpload: this.opts.completeMultipartUpload.bind(this, file),\n        abortMultipartUpload: this.opts.abortMultipartUpload.bind(this, file),\n        getChunkSize: this.opts.getChunkSize ? this.opts.getChunkSize.bind(this) : null,\n\n        onStart,\n        onProgress,\n        onError,\n        onSuccess,\n        onPartComplete,\n\n        limit: this.opts.limit || 5,\n        retryDelays: this.opts.retryDelays || [],\n        ...file.s3Multipart\n      })\n\n      this.uploaders[file.id] = upload\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      let queuedRequest = this.requests.run(() => {\n        if (!file.isPaused) {\n          upload.start()\n        }\n        // Don't do anything here, the caller will take care of cancelling the upload itself\n        // using resetUploaderReferences(). This is because resetUploaderReferences() has to be\n        // called when this request is still in the queue, and has not been started yet, too. At\n        // that point this cancellation function is not going to be called.\n        return () => {}\n      })\n\n      this.onFileRemove(file.id, (removed) => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${removed.id} was removed`)\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          upload.pause()\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            upload.start()\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        upload.pause()\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          upload.abort()\n        }\n        queuedRequest = this.requests.run(() => {\n          upload.start()\n          return () => {}\n        })\n      })\n\n      if (!file.isRestored) {\n        this.uppy.emit('upload-started', file, upload)\n      }\n    })\n  }\n\n  uploadRemote (file) {\n    this.resetUploaderReferences(file.id)\n\n    this.uppy.emit('upload-started', file)\n    if (file.serverToken) {\n      return this.connectToServerSocket(file)\n    }\n\n    return new Promise((resolve, reject) => {\n      const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n      const client = new Client(this.uppy, file.remote.providerOptions)\n      client.post(\n        file.remote.url,\n        {\n          ...file.remote.body,\n          protocol: 's3-multipart',\n          size: file.data.size,\n          metadata: file.meta\n        }\n      ).then((res) => {\n        this.uppy.setFileState(file.id, { serverToken: res.token })\n        file = this.uppy.getFile(file.id)\n        return file\n      }).then((file) => {\n        return this.connectToServerSocket(file)\n      }).then(() => {\n        resolve()\n      }).catch((err) => {\n        this.uppy.emit('upload-error', file, err)\n        reject(err)\n      })\n    })\n  }\n\n  connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      const socket = new Socket({ target: `${host}/api/${token}`, autoOpen: false })\n      this.uploaderSockets[file.id] = socket\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      this.onFileRemove(file.id, (removed) => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          socket.send('pause', {})\n        } else {\n          // Resuming an upload should be queued, else you could pause and then resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            socket.send('resume', {})\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n        this.resetUploaderReferences(file.id)\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          socket.send('pause', {})\n        }\n        queuedRequest = this.requests.run(() => {\n          socket.send('resume', {})\n        })\n      })\n\n      this.onRetry(file.id, () => {\n        // Only do the retry if the upload is actually in progress;\n        // else we could try to send these messages when the upload is still queued.\n        // We may need a better check for this since the socket may also be closed\n        // for other reasons, like network failures.\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      this.onRetryAll(file.id, () => {\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n      socket.on('error', (errData) => {\n        this.uppy.emit('upload-error', file, new Error(errData.error))\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        reject(new Error(errData.error))\n      })\n\n      socket.on('success', (data) => {\n        const uploadResp = {\n          uploadURL: data.url\n        }\n\n        this.uppy.emit('upload-success', file, uploadResp)\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        resolve()\n      })\n\n      let queuedRequest = this.requests.run(() => {\n        socket.open()\n        if (file.isPaused) {\n          socket.send('pause', {})\n        }\n\n        return () => {}\n      })\n    })\n  }\n\n  upload (fileIDs) {\n    if (fileIDs.length === 0) return Promise.resolve()\n\n    const promises = fileIDs.map((id) => {\n      const file = this.uppy.getFile(id)\n      if (file.isRemote) {\n        return this.uploadRemote(file)\n      }\n      return this.uploadFile(file)\n    })\n\n    return Promise.all(promises)\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onFilePause (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-pause', (targetFileID, isPaused) => {\n      if (fileID === targetFileID) {\n        // const isPaused = this.uppy.pauseResume(fileID)\n        cb(isPaused)\n      }\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', (filesToRetry) => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onPauseAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('pause-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('cancel-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onResumeAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('resume-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  install () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: true\n      }\n    })\n    this.uppy.addUploader(this.upload)\n  }\n\n  uninstall () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: false\n      }\n    })\n    this.uppy.removeUploader(this.upload)\n  }\n}\n"]}