{"version":3,"sources":["SharedHandler.js"],"names":["remoteFileObjToLocal","require","module","exports","plugin","filterItems","bind","toggleCheckbox","isChecked","loaderWrapper","items","state","getPluginState","filterInput","filter","folder","name","toLowerCase","indexOf","e","file","stopPropagation","preventDefault","currentTarget","focus","folders","files","concat","lastCheckbox","shiftKey","currentSelection","prevIndex","currentIndex","slice","reduce","reducedCurrentSelection","item","uppy","validatedRestrictions","validateRestrictions","getFiles","result","info","message","reason","opts","infoTimeout","setPluginState","id","some","promise","then","catch_","loading","catch","err"],"mappings":"AAAA,IAAMA,oBAAoB,GAAGC,OAAO,CAAC,sCAAD,CAApC;;AAEAC,MAAM,CAACC,OAAP;AACE,yBAAaC,MAAb,EAAqB;AACnB,SAAKA,MAAL,GAAcA,MAAd;AACA,SAAKC,WAAL,GAAmB,KAAKA,WAAL,CAAiBC,IAAjB,CAAsB,IAAtB,CAAnB;AACA,SAAKC,cAAL,GAAsB,KAAKA,cAAL,CAAoBD,IAApB,CAAyB,IAAzB,CAAtB;AACA,SAAKE,SAAL,GAAiB,KAAKA,SAAL,CAAeF,IAAf,CAAoB,IAApB,CAAjB;AACA,SAAKG,aAAL,GAAqB,KAAKA,aAAL,CAAmBH,IAAnB,CAAwB,IAAxB,CAArB;AACD;;AAPH;;AAAA,SASED,WATF,GASE,qBAAaK,KAAb,EAAoB;AAClB,QAAMC,KAAK,GAAG,KAAKP,MAAL,CAAYQ,cAAZ,EAAd;;AACA,QAAI,CAACD,KAAK,CAACE,WAAP,IAAsBF,KAAK,CAACE,WAAN,KAAsB,EAAhD,EAAoD;AAClD,aAAOH,KAAP;AACD;;AACD,WAAOA,KAAK,CAACI,MAAN,CAAa,UAACC,MAAD,EAAY;AAC9B,aAAOA,MAAM,CAACC,IAAP,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkCP,KAAK,CAACE,WAAN,CAAkBI,WAAlB,EAAlC,MAAuE,CAAC,CAA/E;AACD,KAFM,CAAP;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AAzBA;;AAAA,SA0BEV,cA1BF,GA0BE,wBAAgBY,CAAhB,EAAmBC,IAAnB,EAAyB;AAAA;;AACvBD,IAAAA,CAAC,CAACE,eAAF;AACAF,IAAAA,CAAC,CAACG,cAAF;AACAH,IAAAA,CAAC,CAACI,aAAF,CAAgBC,KAAhB;;AAHuB,gCAII,KAAKpB,MAAL,CAAYQ,cAAZ,EAJJ;AAAA,QAIfa,OAJe,yBAIfA,OAJe;AAAA,QAINC,KAJM,yBAINA,KAJM;;AAKvB,QAAMhB,KAAK,GAAG,KAAKL,WAAL,CAAiBoB,OAAO,CAACE,MAAR,CAAeD,KAAf,CAAjB,CAAd,CALuB,CAOvB;AACA;;AACA,QAAI,KAAKE,YAAL,IAAqBT,CAAC,CAACU,QAA3B,EAAqC;AACnC,UAAIC,iBAAJ;;AACA,UAAMC,SAAS,GAAGrB,KAAK,CAACQ,OAAN,CAAc,KAAKU,YAAnB,CAAlB;AACA,UAAMI,YAAY,GAAGtB,KAAK,CAACQ,OAAN,CAAcE,IAAd,CAArB;;AACA,UAAIW,SAAS,GAAGC,YAAhB,EAA8B;AAC5BF,QAAAA,iBAAgB,GAAGpB,KAAK,CAACuB,KAAN,CAAYF,SAAZ,EAAuBC,YAAY,GAAG,CAAtC,CAAnB;AACD,OAFD,MAEO;AACLF,QAAAA,iBAAgB,GAAGpB,KAAK,CAACuB,KAAN,CAAYD,YAAZ,EAA0BD,SAAS,GAAG,CAAtC,CAAnB;AACD,OARkC,CASnC;AACA;;;AACAD,MAAAA,iBAAgB,GAAGA,iBAAgB,CAACI,MAAjB,CAAwB,UAACC,uBAAD,EAA0BC,IAA1B,EAAmC;AAC5E,YAAMC,IAAI,GAAG,KAAI,CAACjC,MAAL,CAAYiC,IAAzB;AACA,YAAMC,qBAAqB,GAAGD,IAAI,CAACE,oBAAL,CAC5BvC,oBAAoB,CAACoC,IAAD,CADQ,YAExBC,IAAI,CAACG,QAAL,EAFwB,EAEJL,uBAFI,EAA9B;;AAIA,YAAI,CAACG,qBAAqB,CAACG,MAA3B,EAAmC;AACjCJ,UAAAA,IAAI,CAACK,IAAL,CAAU;AAAEC,YAAAA,OAAO,EAAEL,qBAAqB,CAACM;AAAjC,WAAV,EAAqD,OAArD,EAA8DP,IAAI,CAACQ,IAAL,CAAUC,WAAxE;AACA,iBAAOX,uBAAP;AACD;;AACD,yBAAWA,uBAAX,GAAoCC,IAApC;AACD,OAXkB,CAAnB;AAYA,WAAKhC,MAAL,CAAY2C,cAAZ,CAA2B;AAAEjB,QAAAA,gBAAgB,EAAhBA;AAAF,OAA3B;AACA;AACD;;AAED,SAAKF,YAAL,GAAoBR,IAApB;;AApCuB,iCAqCM,KAAKhB,MAAL,CAAYQ,cAAZ,EArCN;AAAA,QAqCfkB,gBArCe,0BAqCfA,gBArCe;;AAsCvB,QAAI,KAAKtB,SAAL,CAAeY,IAAf,CAAJ,EAA0B;AACxB,WAAKhB,MAAL,CAAY2C,cAAZ,CAA2B;AACzBjB,QAAAA,gBAAgB,EAAEA,gBAAgB,CAAChB,MAAjB,CAAwB,UAACsB,IAAD;AAAA,iBAAUA,IAAI,CAACY,EAAL,KAAY5B,IAAI,CAAC4B,EAA3B;AAAA,SAAxB;AADO,OAA3B;AAGD,KAJD,MAIO;AACL,WAAK5C,MAAL,CAAY2C,cAAZ,CAA2B;AACzBjB,QAAAA,gBAAgB,EAAEA,gBAAgB,CAACH,MAAjB,CAAwB,CAACP,IAAD,CAAxB;AADO,OAA3B;AAGD;AACF,GAzEH;;AAAA,SA2EEZ,SA3EF,GA2EE,mBAAWY,IAAX,EAAiB;AAAA,iCACc,KAAKhB,MAAL,CAAYQ,cAAZ,EADd;AAAA,QACPkB,gBADO,0BACPA,gBADO,EAEf;AACA;;;AACA,WAAOA,gBAAgB,CAACmB,IAAjB,CAAsB,UAACb,IAAD;AAAA,aAAUA,IAAI,CAACY,EAAL,KAAY5B,IAAI,CAAC4B,EAA3B;AAAA,KAAtB,CAAP;AACD,GAhFH;;AAAA,SAkFEvC,aAlFF,GAkFE,uBAAeyC,OAAf,EAAwBC,IAAxB,EAA8BC,MAA9B,EAAsC;AAAA;;AACpCF,IAAAA,OAAO,CACJC,IADH,CACQ,UAACV,MAAD,EAAY;AAChB,MAAA,MAAI,CAACrC,MAAL,CAAY2C,cAAZ,CAA2B;AAAEM,QAAAA,OAAO,EAAE;AAAX,OAA3B;;AACAF,MAAAA,IAAI,CAACV,MAAD,CAAJ;AACD,KAJH,EAIKa,KAJL,CAIW,UAACC,GAAD,EAAS;AAChB,MAAA,MAAI,CAACnD,MAAL,CAAY2C,cAAZ,CAA2B;AAAEM,QAAAA,OAAO,EAAE;AAAX,OAA3B;;AACAD,MAAAA,MAAM,CAACG,GAAD,CAAN;AACD,KAPH;AAQA,SAAKnD,MAAL,CAAY2C,cAAZ,CAA2B;AAAEM,MAAAA,OAAO,EAAE;AAAX,KAA3B;AACD,GA5FH;;AAAA;AAAA","sourcesContent":["const remoteFileObjToLocal = require('@uppy/utils/lib/remoteFileObjToLocal')\n\nmodule.exports = class SharedHandler {\n  constructor (plugin) {\n    this.plugin = plugin\n    this.filterItems = this.filterItems.bind(this)\n    this.toggleCheckbox = this.toggleCheckbox.bind(this)\n    this.isChecked = this.isChecked.bind(this)\n    this.loaderWrapper = this.loaderWrapper.bind(this)\n  }\n\n  filterItems (items) {\n    const state = this.plugin.getPluginState()\n    if (!state.filterInput || state.filterInput === '') {\n      return items\n    }\n    return items.filter((folder) => {\n      return folder.name.toLowerCase().indexOf(state.filterInput.toLowerCase()) !== -1\n    })\n  }\n\n  /**\n   * Toggles file/folder checkbox to on/off state while updating files list.\n   *\n   * Note that some extra complexity comes from supporting shift+click to\n   * toggle multiple checkboxes at once, which is done by getting all files\n   * in between last checked file and current one.\n   */\n  toggleCheckbox (e, file) {\n    e.stopPropagation()\n    e.preventDefault()\n    e.currentTarget.focus()\n    const { folders, files } = this.plugin.getPluginState()\n    const items = this.filterItems(folders.concat(files))\n\n    // Shift-clicking selects a single consecutive list of items\n    // starting at the previous click and deselects everything else.\n    if (this.lastCheckbox && e.shiftKey) {\n      let currentSelection\n      const prevIndex = items.indexOf(this.lastCheckbox)\n      const currentIndex = items.indexOf(file)\n      if (prevIndex < currentIndex) {\n        currentSelection = items.slice(prevIndex, currentIndex + 1)\n      } else {\n        currentSelection = items.slice(currentIndex, prevIndex + 1)\n      }\n      // Check restrictions on each file in currentSelection,\n      // reduce it to only contain files that pass restrictions\n      currentSelection = currentSelection.reduce((reducedCurrentSelection, item) => {\n        const uppy = this.plugin.uppy\n        const validatedRestrictions = uppy.validateRestrictions(\n          remoteFileObjToLocal(item),\n          [...uppy.getFiles(), ...reducedCurrentSelection]\n        )\n        if (!validatedRestrictions.result) {\n          uppy.info({ message: validatedRestrictions.reason }, 'error', uppy.opts.infoTimeout)\n          return reducedCurrentSelection\n        }\n        return [...reducedCurrentSelection, item]\n      })\n      this.plugin.setPluginState({ currentSelection })\n      return\n    }\n\n    this.lastCheckbox = file\n    const { currentSelection } = this.plugin.getPluginState()\n    if (this.isChecked(file)) {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.filter((item) => item.id !== file.id)\n      })\n    } else {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.concat([file])\n      })\n    }\n  }\n\n  isChecked (file) {\n    const { currentSelection } = this.plugin.getPluginState()\n    // comparing id instead of the file object, because the reference to the object\n    // changes when we switch folders, and the file list is updated\n    return currentSelection.some((item) => item.id === file.id)\n  }\n\n  loaderWrapper (promise, then, catch_) {\n    promise\n      .then((result) => {\n        this.plugin.setPluginState({ loading: false })\n        then(result)\n      }).catch((err) => {\n        this.plugin.setPluginState({ loading: false })\n        catch_(err)\n      })\n    this.plugin.setPluginState({ loading: true })\n  }\n}\n"]}